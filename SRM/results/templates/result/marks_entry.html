{% extends 'base.html' %}
{% load static %}

{% block title %}Marks Entry - {{ subject.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Marks Entry</h2>
            <p class="text-muted">
                <strong>Subject:</strong> {{ subject.code }} - {{ subject.name }}<br>
                <strong>Program:</strong> {{ subject.program.name }} | 
                <strong>Semester:</strong> {{ subject.semester }} |
                <strong>Academic Year:</strong> {{ academic_year }}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'teacher_marks_entry_subjects' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Subjects
            </a>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Max Marks:</strong> Internal = 30, External = 70, Total = 100 | 
                    <strong>Passing Marks:</strong> {{ subject.passing_marks }}
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 15%;">Enrollment</th>
                                <th style="width: 25%;">Student Name</th>
                                <th style="width: 15%;">Internal (30)</th>
                                <th style="width: 15%;">External (70)</th>
                                <th style="width: 10%;">Total</th>
                                <th style="width: 10%;">Grade</th>
                                <th style="width: 10%;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in marks_data %}
                            <tr>
                                <td>{{ data.student.enrollment_number }}</td>
                                <td>{{ data.student.user.get_full_name }}</td>
                                <td>
                                    <input type="number" 
                                           name="internal_{{ data.student.id }}" 
                                           class="form-control form-control-sm"
                                           min="0" max="30"
                                           value="{{ data.marks.internal_marks|default:'' }}"
                                           onchange="calculateTotal({{ data.student.id }})">
                                </td>
                                <td>
                                    <input type="number" 
                                           name="external_{{ data.student.id }}" 
                                           class="form-control form-control-sm"
                                           min="0" max="70"
                                           value="{{ data.marks.external_marks|default:'' }}"
                                           onchange="calculateTotal({{ data.student.id }})">
                                </td>
                                <td>
                                    <span id="total_{{ data.student.id }}" class="badge bg-primary">
                                        {{ data.marks.total_marks|default:'0' }}
                                    </span>
                                </td>
                                <td>
                                    {% if data.marks %}
                                        <span class="badge bg-info">{{ data.marks.grade }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if data.marks %}
                                        {% if data.marks.is_passed %}
                                            <span class="badge bg-success">Pass</span>
                                        {% else %}
                                            <span class="badge bg-danger">Fail</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    No students found for this subject.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if marks_data %}
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save All Marks
                    </button>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block extra_js %}
<script>
function calculateTotal(studentId) {
    const internal = parseInt(document.querySelector(`input[name="internal_${studentId}"]`).value) || 0;
    const external = parseInt(document.querySelector(`input[name="external_${studentId}"]`).value) || 0;
    const total = internal + external;
    document.getElementById(`total_${studentId}`).textContent = total;
}
</script>
{% endblock %}